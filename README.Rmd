---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "70%"
)
```

# SETrNCBN

<!-- badges: start -->

[![R-CMD-check](https://github.com/laura-feher/NCBN_SETr/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/laura-feher/NCBN_SETr/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

The goal of SETrNCBN is to simplify the calculation of cumulative rates of surface elevation change and vertical accretion from the National Park Services' Surface Elevation Table (SET) data.

This package is based on the [SETr](https://github.com/swmpkim/SETr) package developed by Kim Cressman.

## Installation

You can install the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("laura-feher/SETrNCBN")
```

## Load SET or MH data

Data can be pulled from the NPS I&M SET database using `load_set_data()` for SET data or `load_mh_data()` for MH data. Use the network code (`network_code`) or park code (`park_code`) arguments to filter the data to a specific I&M network(s) or park(s) using the appropriate 4-letter code.

```{r message = FALSE, warning = FALSE}
library(SETrNCBN)
library(tidyverse)

set_df <- load_set_data(network_code = "NETN") %>%
    select(network_code, park_code, site_name, station_code, event_date_UTC, SET_direction, pin_position, pin_height_mm)

head(set_df)
```

You can also supply a list of multiple parks or networks:

```{r message = FALSE, warning = FALSE}
set_df <- load_set_data(park = c("ASIS", "COLO")) %>%
    select(network_code, park_code, site_name, station_code, event_date_UTC, SET_direction, pin_position, pin_height_mm)

head(set_df)
```

Alternatively, if you have your data saved in a csv or xlsx file, you can load it into R by supplying a file path. See `? help(calc_change_cumu)` for required columns and data types if supplying your own data.

```{r message = FALSE, warning = FALSE}
set_df <- load_set_data(file_path = "./data/example_sets.csv")

head(set_df)
```

## Calculate cumulative change

The function `calc_change_cumu()` can be used to calculate station- or site-level cumulative surface elevation change from SET data or vertical accretion from MH data. The resulting data frame has the mean station- or site-level cumulative change for each sampling date.

```{r message=FALSE, warning=FALSE}

# station-level rates of change
example_cumu_station <- calc_change_cumu(example_sets, level = "station")
head(example_cumu_station)

# site-level rates of change
example_cumu_site <- calc_change_cumu(example_sets, level = "site")
head(example_cumu_site)
```

## Plotting cumulative change

The function `plot_cumu()` can be used to plot station- or site-level cumulative surface elevation change from SET data or vertical accretion from MH data. You can also plot SET data and MH data on the same plot by supplying data frames to both the `SET_data` and `MH_data` arguments.

```{r message=FALSE, warning=FALSE}
plot_cumu(SET_data = example_sets, level = "station")
```

```{r message=FALSE, warning=FALSE}
plot_cumu(MH_data = example_mh, level = "station")
```

```{r message=FALSE, warning=FALSE}
library(ggh4x)

# Plot SET and MH data for each station together on a single plot:
plot_cumu(SET_data = example_sets, MH_data = example_mh, columns = 2)
```

## Calculate linear rates of change

The function `calc_linear_rates()` can be used to calculate simple linear rates of change at the station-or site-level in mm/yr.

```{r message=FALSE, warning=FALSE}
station_rates <- calc_linear_rates(example_sets, level = "station")

station_rates %>%
    dplyr::ungroup() %>%
    dplyr::select(park_code, site_name, station_code, rate, rate_se, rate_level)

site_rates <- calc_linear_rates(example_sets, level = "site")

site_rates %>%
    dplyr::ungroup() %>%
    dplyr::select(park_code, site_name, rate, rate_se, rate_level)
```

## Visually compare rates of change

The function `plot_rate_comps()` can be used to create 'tie fighter' plots that are helpful for visually comparing rates of surface elevation change or vertical accretion between stations or sites:

```{r message=FALSE, warning=FALSE}
plot_rate_comps(example_sets, level = "station")
```

Alternatively, if you've already calculated rates of change and want to plot those, you can use the 'rates' argument to supply a data frame of rates that has columns for station IDs, station-level rates, and station rate std errors with one row per station:

```{r message=FALSE, warning=FALSE}
example_rates <- data.frame(
    "station_code" = c("station_1", "station_2", "station_3"),
    "rate" = c(3.2, 4.0, 5.4),
    "rate_se" = c(1, 0.5, 0.25)) %>%
    mutate(network_code = "NCBN",
           park_code = "ABCD",
           site_name = "Site A") %>%
    group_by(network_code, park_code, site_name, station_code) %>%
    select(network_code, park_code, site_name, station_code, rate, rate_se)

plot_rate_comps(rates = example_rates, level = "station")
```

## Get park-specific SLR data & rates

The function `get_sea_level_data()` can be used to get rates of sea-level rise from the NOAA tide gauge that is closest to a specific park. The function returns a list with 2 data frames: 'slr_data' is the relative sea-level data downloaded from the NOAA tides and currents website; 'slr_rate' provides the calculated rate of sea-level rise, standard error of the SLR rate, lower confidence interval, upper, minimum year of data used for calculating SLR, and maximum year of data used for calculating SLR. You can access each data frame in the list using `$` or `[]` notation. 

```{r message=FALSE, warning=FALSE}
ASIS_sea_level <- get_sea_level_data("ASIS")

head(ASIS_sea_level$slr_data)

head(ASIS_sea_level$slr_rate)
```

You can also supply a start year and/or end year if you want to limit the calculation of SLR to a specific time frame. This could be useful for calculating a SLR rate from the most recent tidal datum:

```{r message=FALSE, warning=FALSE}
ASIS_sea_level_2001_2019 <- get_sea_level_data("ASIS", trend_start_year = 2001, trend_end_year = 2019)

head(ASIS_sea_level_2001_2019$slr_data)

head(ASIS_sea_level_2001_2019$slr_rate)
```
